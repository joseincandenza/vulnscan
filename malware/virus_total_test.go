package malware

import (
	"github.com/simplycubed/vulnscan/utils"
	"testing"
)

func TestVirusTotalClient(t *testing.T) {
	client, err := NewVirusTotalClient("9b1157e6f334deda9f6d0c60a91f9c34bd02d7d44b200305c3cd2a36594d0f9c")
	if err != nil {
		t.Error(err)
	}
	p, _ := utils.FindTest("apps", "binary.ipa")
	r, e := client.makeApiRequest("POST", "file/scan", map[string]string{"file": p})
	if e != nil {
		t.Errorf("%s", e)
	} else if msg:= r["verbose_msg"]; msg != "Scan request successfully queued, come back later for the report" {
		t.Errorf("Wrong api response: %s", msg)
	}
	hash, _ := utils.HashMD5(p)
	if hash != "b956666c9670cff7166d28af88a3e063" {
		t.Errorf("Wrong hash, if the file has changed, update the test")
	}
	r, e = client.makeApiRequest("GET", "file/report", map[string]string{"resource": hash})
	if e != nil {
		t.Errorf("%s", e)
	} else if msg:= r["verbose_msg"]; msg != "Scan finished, information embedded" {
		t.Errorf("Wrong api response: %s", msg)
	}
	t.Error(r)
}


