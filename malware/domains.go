package malware

import (
	"bufio"
	"encoding/csv"
	"io"
	"net/http"
	"net/url"
)

type MalwareDomain struct {
	Date string
	Domain string
	IP string
	ReverseLookup string
	Description string
	ASN string
	Country string
}

func getDataBase() (domainList []MalwareDomain, err error) {
	// Get the data
	resp, err := http.Get("http://www.malwaredomainlist.com/mdlcsv.php")
	if err != nil {
		return domainList, err
	}
	defer resp.Body.Close()
	reader := csv.NewReader(bufio.NewReader(resp.Body))
	for {
		line, err := reader.Read()
		if err == io.EOF {
			break
		} else if err != nil {
			return domainList, err
		}
		domainList = append(domainList, MalwareDomain{
			line[0],
			line[1],
			line[2],
			line[3],
			line[4],
			line[5],
			line[6],
		})
	}
	return domainList, nil
}

func getDomain(u string) (string, error)  {
	parsedUrl, e := url.Parse(u)
	if e != nil {
		return "", e
	}
	return parsedUrl.Host, nil
}

func MalwareCheck(urls []string) (badDomains []string, err error){
	if database, err := getDataBase(); err != nil {
		return badDomains, err
	} else {
		for _, u := range urls {
			for _, dom := range database {
				if domain, err := getDomain(u); err != nil && domain == dom.Domain {
					badDomains = append(badDomains, u)
				}
			}
		}
	}
	return badDomains, nil
}